<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e">
<title>Carnet de Classe</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ============================================================
   RESET & VARIABLES
============================================================ */
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

:root {
‚Äìbg: #f0ece4;
‚Äìsurface: #fffef9;
‚Äìdark: #1a1a2e;
‚Äìgreen: #2d6a4f;
‚Äìgreen-light: #d8f3dc;
‚Äìaccent: #e76f51;
‚Äìaccent2: #f4a261;
‚Äìmuted: #6b7280;
‚Äìborder: #e5ddd0;
‚Äìradius: 14px;
‚Äìshadow: 0 4px 20px rgba(0,0,0,0.1);

‚Äìaplus: #2d6a4f;
‚Äìa:     #52b788;
‚Äìea:    #f4a261;
‚Äìna:    #e76f51;
‚Äìabs:   #9ca3af;
}

html, body { height: 100%; overflow: hidden; }

body {
font-family: ‚ÄòNunito‚Äô, sans-serif;
background: var(‚Äìbg);
color: var(‚Äìdark);
display: flex;
flex-direction: column;
}

/* ============================================================
HEADER
============================================================ */
.header {
background: var(‚Äìdark);
padding: 14px 16px 10px;
display: flex;
align-items: center;
justify-content: space-between;
flex-shrink: 0;
padding-top: max(14px, env(safe-area-inset-top));
}
.header-title {
display: flex;
align-items: center;
gap: 10px;
color: white;
font-size: 1.1rem;
font-weight: 800;
}
.header-badge {
background: var(‚Äìaccent);
font-size: 0.65rem;
padding: 3px 8px;
border-radius: 6px;
font-weight: 700;
letter-spacing: 0.5px;
}
.header-btn {
background: rgba(255,255,255,0.12);
border: none;
color: white;
border-radius: 10px;
padding: 8px 12px;
font-size: 1rem;
cursor: pointer;
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-weight: 700;
display: flex;
align-items: center;
gap: 6px;
}

/* ============================================================
BOTTOM NAV
============================================================ */
.bottom-nav {
background: var(‚Äìdark);
display: flex;
border-top: 1px solid rgba(255,255,255,0.08);
flex-shrink: 0;
padding-bottom: max(8px, env(safe-area-inset-bottom));
}
.nav-item {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
padding: 10px 4px 6px;
color: rgba(255,255,255,0.4);
cursor: pointer;
border: none;
background: none;
font-family: ‚ÄòNunito‚Äô, sans-serif;
transition: color 0.2s;
gap: 3px;
}
.nav-item.active { color: var(‚Äìaccent2); }
.nav-icon { font-size: 1.3rem; }
.nav-label { font-size: 0.62rem; font-weight: 700; letter-spacing: 0.3px; }

/* ============================================================
MAIN CONTENT
============================================================ */
.main {
flex: 1;
overflow-y: auto;
overflow-x: hidden;
-webkit-overflow-scrolling: touch;
}

/* SCREENS */
.screen { display: none; padding: 16px; }
.screen.active { display: block; }

/* ============================================================
STATS CARDS
============================================================ */
.stats-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;
margin-bottom: 16px;
}
.stat-card {
background: var(‚Äìsurface);
border-radius: var(‚Äìradius);
padding: 14px 16px;
position: relative;
overflow: hidden;
border: 1.5px solid var(‚Äìborder);
}
.stat-card::before {
content: ‚Äò‚Äô;
position: absolute;
top: 0; left: 0; right: 0;
height: 4px;
}
.stat-card.aplus::before { background: var(‚Äìaplus); }
.stat-card.a::before     { background: var(‚Äìa); }
.stat-card.ea::before    { background: var(‚Äìea); }
.stat-card.na::before    { background: var(‚Äìna); }
.stat-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(‚Äìmuted); }
.stat-value { font-size: 2rem; font-weight: 800; margin: 4px 0 0; }
.stat-card.aplus .stat-value { color: var(‚Äìaplus); }
.stat-card.a .stat-value     { color: var(‚Äìa); }
.stat-card.ea .stat-value    { color: var(‚Äìea); }
.stat-card.na .stat-value    { color: var(‚Äìna); }

/* SECTION TITLE */
.section-title {
font-size: 0.7rem;
font-weight: 800;
text-transform: uppercase;
letter-spacing: 1.5px;
color: var(‚Äìmuted);
margin: 20px 0 10px;
}

/* ============================================================
FILTER BAR
============================================================ */
.filter-bar {
display: flex;
gap: 8px;
overflow-x: auto;
padding-bottom: 4px;
margin-bottom: 14px;
scrollbar-width: none;
}
.filter-bar::-webkit-scrollbar { display: none; }
.filter-chip {
flex-shrink: 0;
padding: 7px 14px;
border-radius: 20px;
border: 1.5px solid var(‚Äìborder);
background: var(‚Äìsurface);
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 0.78rem;
font-weight: 700;
color: var(‚Äìmuted);
cursor: pointer;
}
.filter-chip.active {
background: var(‚Äìdark);
color: white;
border-color: var(‚Äìdark);
}

/* ============================================================
√âL√àVE CARDS
============================================================ */
.eleve-card {
background: var(‚Äìsurface);
border-radius: var(‚Äìradius);
padding: 14px 16px;
margin-bottom: 10px;
border: 1.5px solid var(‚Äìborder);
display: flex;
align-items: center;
justify-content: space-between;
cursor: pointer;
transition: transform 0.15s, box-shadow 0.15s;
-webkit-tap-highlight-color: transparent;
}
.eleve-card:active { transform: scale(0.98); }
.eleve-info { flex: 1; }
.eleve-name { font-weight: 800; font-size: 0.95rem; }
.eleve-sub { font-size: 0.72rem; color: var(‚Äìmuted); margin-top: 2px; display: flex; align-items: center; gap: 6px; }
.niveau-badge {
font-size: 0.6rem;
padding: 2px 7px;
border-radius: 5px;
font-weight: 800;
}
.ce2 { background: #dbeafe; color: #1d4ed8; }
.cm1 { background: #ede9fe; color: #7c3aed; }
.eleve-score {
font-size: 1.3rem;
font-weight: 800;
min-width: 48px;
text-align: right;
}
.mini-grades {
display: flex;
gap: 4px;
margin-top: 6px;
flex-wrap: wrap;
}
.mini-pill {
font-size: 0.6rem;
font-weight: 800;
padding: 2px 6px;
border-radius: 5px;
color: white;
}

/* ============================================================
GRILLE DE NOTES
============================================================ */
.grille-table-wrap {
overflow-x: auto;
border-radius: var(‚Äìradius);
border: 1.5px solid var(‚Äìborder);
background: var(‚Äìsurface);
-webkit-overflow-scrolling: touch;
}
table { border-collapse: collapse; font-size: 0.72rem; }
.th-name {
position: sticky;
left: 0;
background: var(‚Äìdark);
color: white;
padding: 10px 10px;
text-align: left;
min-width: 120px;
z-index: 10;
font-weight: 800;
font-size: 0.7rem;
}
th {
background: var(‚Äìdark);
color: rgba(255,255,255,0.8);
padding: 8px 6px;
text-align: center;
white-space: nowrap;
font-weight: 700;
font-size: 0.65rem;
max-width: 70px;
}
.th-sub {
font-size: 0.6rem;
color: rgba(255,255,255,0.5);
font-weight: 400;
display: block;
margin-top: 2px;
}
.td-name {
position: sticky;
left: 0;
background: var(‚Äìsurface);
padding: 8px 10px;
font-weight: 700;
font-size: 0.72rem;
border-right: 2px solid var(‚Äìborder);
border-bottom: 1px solid var(‚Äìborder);
white-space: nowrap;
z-index: 5;
}
.td-grade {
padding: 6px 4px;
text-align: center;
border-bottom: 1px solid var(‚Äìborder);
}
.grade-pill {
display: inline-flex;
align-items: center;
justify-content: center;
width: 36px;
height: 26px;
border-radius: 6px;
font-size: 0.65rem;
font-weight: 800;
cursor: pointer;
transition: transform 0.1s;
}
.grade-pill:active { transform: scale(0.9); }
.grade-pill.APLUS { background: var(‚Äìaplus); color: white; }
.grade-pill.A     { background: var(‚Äìa);     color: white; }
.grade-pill.EA    { background: var(‚Äìea);    color: white; }
.grade-pill.NA    { background: var(‚Äìna);    color: white; }
.grade-pill.ABS   { background: var(‚Äìabs);   color: white; }
.grade-pill.EMPTY { background: #ede9e0; color: #bbb; font-size: 0.8rem; }

/* MATIERE HEADER */
.th-matiere {
background: #2a2a40;
color: rgba(255,255,255,0.9);
font-weight: 800;
font-size: 0.65rem;
letter-spacing: 0.5px;
text-transform: uppercase;
}

/* ============================================================
GRADE SELECTOR BOTTOM SHEET
============================================================ */
.overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.5);
z-index: 100;
align-items: flex-end;
}
.overlay.open { display: flex; }
.bottom-sheet {
background: var(‚Äìsurface);
border-radius: 20px 20px 0 0;
padding: 16px 20px;
padding-bottom: max(24px, env(safe-area-inset-bottom));
width: 100%;
animation: slideUp 0.25s ease;
}
@keyframes slideUp {
from { transform: translateY(100%); }
to   { transform: translateY(0); }
}
.sheet-handle {
width: 40px;
height: 4px;
background: var(‚Äìborder);
border-radius: 2px;
margin: 0 auto 16px;
}
.sheet-title { font-size: 0.85rem; font-weight: 800; margin-bottom: 16px; color: var(‚Äìmuted); text-transform: uppercase; letter-spacing: 1px; }
.grade-options {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 10px;
margin-bottom: 12px;
}
.grade-option-btn {
padding: 16px 8px;
border-radius: 12px;
border: none;
color: white;
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 1rem;
font-weight: 800;
cursor: pointer;
display: flex;
flex-direction: column;
align-items: center;
gap: 4px;
transition: transform 0.1s;
}
.grade-option-btn:active { transform: scale(0.94); }
.grade-option-btn .grade-desc { font-size: 0.6rem; font-weight: 600; opacity: 0.85; }
.grade-option-btn.APLUS { background: var(‚Äìaplus); }
.grade-option-btn.A     { background: var(‚Äìa); }
.grade-option-btn.EA    { background: var(‚Äìea); }
.grade-option-btn.NA    { background: var(‚Äìna); }
.grade-option-btn.ABS   { background: var(‚Äìabs); }
.btn-erase {
width: 100%;
padding: 14px;
border-radius: 12px;
border: 1.5px solid var(‚Äìborder);
background: var(‚Äìbg);
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 0.9rem;
font-weight: 700;
color: var(‚Äìmuted);
cursor: pointer;
}

/* ============================================================
MODAL (ajout √©l√®ve / comp√©tence)
============================================================ */
.modal-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,0.55);
z-index: 200;
align-items: flex-end;
padding: 0;
}
.modal-overlay.open { display: flex; }
.modal-sheet {
background: var(‚Äìsurface);
border-radius: 20px 20px 0 0;
padding: 20px 20px;
padding-bottom: max(28px, env(safe-area-inset-bottom));
width: 100%;
max-height: 90vh;
overflow-y: auto;
animation: slideUp 0.25s ease;
}
.modal-title {
font-size: 1.1rem;
font-weight: 800;
margin-bottom: 20px;
}
.form-group { margin-bottom: 14px; }
.form-label {
display: block;
font-size: 0.7rem;
font-weight: 800;
text-transform: uppercase;
letter-spacing: 0.8px;
color: var(‚Äìmuted);
margin-bottom: 6px;
}
.form-input {
width: 100%;
padding: 13px 14px;
border: 1.5px solid var(‚Äìborder);
border-radius: 10px;
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 1rem;
background: white;
color: var(‚Äìdark);
-webkit-appearance: none;
}
.form-input:focus { outline: none; border-color: var(‚Äìgreen); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.modal-actions { display: flex; gap: 10px; margin-top: 20px; }
.btn-cancel {
flex: 1;
padding: 14px;
border-radius: 10px;
border: 1.5px solid var(‚Äìborder);
background: var(‚Äìbg);
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 0.9rem;
font-weight: 700;
cursor: pointer;
color: var(‚Äìdark);
}
.btn-save {
flex: 2;
padding: 14px;
border-radius: 10px;
border: none;
background: var(‚Äìgreen);
color: white;
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 0.9rem;
font-weight: 800;
cursor: pointer;
}

/* ============================================================
FAB
============================================================ */
.fab {
position: fixed;
bottom: calc(70px + max(8px, env(safe-area-inset-bottom)));
right: 16px;
width: 56px;
height: 56px;
border-radius: 50%;
background: var(‚Äìaccent);
color: white;
border: none;
font-size: 1.5rem;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 4px 20px rgba(231,111,81,0.5);
cursor: pointer;
z-index: 50;
transition: transform 0.15s;
}
.fab:active { transform: scale(0.92); }

/* ============================================================
TOAST
============================================================ */
.toast {
position: fixed;
bottom: calc(80px + max(8px, env(safe-area-inset-bottom)));
left: 16px;
right: 16px;
background: var(‚Äìdark);
color: white;
padding: 14px 18px;
border-radius: 12px;
font-size: 0.88rem;
font-weight: 700;
z-index: 300;
transform: translateY(20px);
opacity: 0;
transition: all 0.3s;
text-align: center;
}
.toast.show { transform: translateY(0); opacity: 1; }

/* ============================================================
LOADING
============================================================ */
.loading-screen {
position: fixed;
inset: 0;
background: var(‚Äìdark);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 16px;
z-index: 1000;
color: white;
}
.loading-screen.hidden { display: none; }
.spinner {
width: 40px; height: 40px;
border: 4px solid rgba(255,255,255,0.2);
border-top-color: var(‚Äìaccent2);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-title { font-size: 1.2rem; font-weight: 800; }
.loading-sub { font-size: 0.8rem; opacity: 0.6; }

/* ============================================================
CONNEXION SCREEN
============================================================ */
.login-screen {
position: fixed;
inset: 0;
background: var(‚Äìdark);
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 32px 24px;
gap: 20px;
z-index: 900;
}
.login-screen.hidden { display: none; }
.login-logo { font-size: 2.5rem; }
.login-title { color: white; font-size: 1.6rem; font-weight: 800; text-align: center; }
.login-sub { color: rgba(255,255,255,0.5); font-size: 0.85rem; text-align: center; }
.login-input {
width: 100%;
max-width: 320px;
padding: 16px;
border-radius: 12px;
border: none;
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 1rem;
background: rgba(255,255,255,0.1);
color: white;
-webkit-appearance: none;
}
.login-input::placeholder { color: rgba(255,255,255,0.4); }
.login-input:focus { outline: none; background: rgba(255,255,255,0.15); }
.login-btn {
width: 100%;
max-width: 320px;
padding: 16px;
border-radius: 12px;
border: none;
background: var(‚Äìaccent);
color: white;
font-family: ‚ÄòNunito‚Äô, sans-serif;
font-size: 1rem;
font-weight: 800;
cursor: pointer;
}
.login-error { color: var(‚Äìea); font-size: 0.82rem; font-weight: 700; }

/* ELEVE DETAIL */
.back-btn {
display: flex;
align-items: center;
gap: 6px;
color: var(‚Äìgreen);
font-weight: 700;
font-size: 0.88rem;
cursor: pointer;
margin-bottom: 16px;
border: none;
background: none;
padding: 0;
font-family: ‚ÄòNunito‚Äô, sans-serif;
}
.detail-card {
background: var(‚Äìsurface);
border-radius: var(‚Äìradius);
border: 1.5px solid var(‚Äìborder);
padding: 16px;
margin-bottom: 10px;
}
.detail-matiere {
font-size: 0.65rem;
font-weight: 800;
text-transform: uppercase;
letter-spacing: 1px;
color: var(‚Äìmuted);
margin-bottom: 8px;
}
.detail-row {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 0;
border-bottom: 1px solid var(‚Äìborder);
}
.detail-row:last-child { border-bottom: none; }
.detail-comp { font-size: 0.85rem; font-weight: 600; flex: 1; padding-right: 10px; }
</style>

</head>
<body>

<!-- LOADING -->

<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <div class="loading-title">üåø Carnet de Classe</div>
  <div class="loading-sub">Chargement des donn√©es‚Ä¶</div>
</div>

<!-- LOGIN -->

<div class="login-screen hidden" id="loginScreen">
  <div class="login-logo">üåø</div>
  <div class="login-title">Carnet de Classe</div>
  <div class="login-sub">Connectez-vous pour acc√©der √† vos donn√©es</div>
  <input class="login-input" id="loginEmail" type="email" placeholder="votre@email.com" autocomplete="email">
  <input class="login-input" id="loginPassword" type="password" placeholder="Mot de passe" autocomplete="current-password">
  <button class="login-btn" onclick="doLogin()">Se connecter</button>
  <div class="login-error hidden" id="loginError"></div>
</div>

<!-- HEADER -->

<div class="header" id="appHeader" style="display:none">
  <div class="header-title">
    üåø Carnet
    <span class="header-badge">CE2¬∑CM1</span>
  </div>
  <button class="header-btn" id="headerActionBtn">+ Ajouter</button>
</div>

<!-- MAIN -->

<div class="main" id="appMain" style="display:none">

  <!-- ACCUEIL -->

  <div class="screen active" id="screen-accueil">
    <div class="section-title">Tableau de bord</div>
    <div class="stats-grid">
      <div class="stat-card aplus"><div class="stat-label">A+ Excellent</div><div class="stat-value" id="stat-aplus">‚Äî</div></div>
      <div class="stat-card a"><div class="stat-label">A Satisfaisant</div><div class="stat-value" id="stat-a">‚Äî</div></div>
      <div class="stat-card ea"><div class="stat-label">EA En cours</div><div class="stat-value" id="stat-ea">‚Äî</div></div>
      <div class="stat-card na"><div class="stat-label">NA Non acquis</div><div class="stat-value" id="stat-na">‚Äî</div></div>
    </div>

```
<div class="section-title">√âl√®ves</div>
<div class="filter-bar">
  <button class="filter-chip active" onclick="filterEleves(this,'all')">Tous</button>
  <button class="filter-chip" onclick="filterEleves(this,'CE2')">CE2</button>
  <button class="filter-chip" onclick="filterEleves(this,'CM1')">CM1</button>
</div>
<div id="elevesList"></div>
```

  </div>

  <!-- GRILLE -->

  <div class="screen" id="screen-grille">
    <div class="section-title">Filtrer</div>
    <div class="filter-bar" id="periodeFilter">
      <button class="filter-chip active" onclick="filterPeriode(this,'all')">Toutes p√©riodes</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P1')">P1</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P2')">P2</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P3')">P3</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P4')">P4</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P5')">P5</button>
    </div>
    <div class="grille-table-wrap">
      <table id="grilleTable">
        <thead id="grilleHead"></thead>
        <tbody id="grilleBody"></tbody>
      </table>
    </div>
  </div>

  <!-- BILAN √âL√àVE (detail) -->

  <div class="screen" id="screen-detail">
    <button class="back-btn" onclick="showScreen('accueil')">‚Üê Retour</button>
    <div id="detailContent"></div>
  </div>

</div>

<!-- BOTTOM NAV -->

<div class="bottom-nav" id="appNav" style="display:none">
  <button class="nav-item active" onclick="switchNav(this,'accueil')">
    <span class="nav-icon">üè†</span>
    <span class="nav-label">Accueil</span>
  </button>
  <button class="nav-item" onclick="switchNav(this,'grille')">
    <span class="nav-icon">üìä</span>
    <span class="nav-label">Grille</span>
  </button>
</div>

<!-- FAB -->

<button class="fab" id="fabBtn" style="display:none" onclick="openAddMenu()">Ôºã</button>

<!-- GRADE SELECTOR SHEET -->

<div class="overlay" id="gradeOverlay" onclick="closeGradeSheet()">
  <div class="bottom-sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">Choisir une note</div>
    <div class="grade-options">
      <button class="grade-option-btn APLUS" onclick="selectGrade('A+')">A+<span class="grade-desc">Excellent</span></button>
      <button class="grade-option-btn A"     onclick="selectGrade('A')">A<span class="grade-desc">Satisfaisant</span></button>
      <button class="grade-option-btn EA"    onclick="selectGrade('EA')">EA<span class="grade-desc">En cours</span></button>
      <button class="grade-option-btn NA"    onclick="selectGrade('NA')">NA<span class="grade-desc">Non acquis</span></button>
      <button class="grade-option-btn ABS"   onclick="selectGrade('ABS')">ABS<span class="grade-desc">Absent</span></button>
    </div>
    <button class="btn-erase" onclick="selectGrade(null)">‚úï Effacer la note</button>
  </div>
</div>

<!-- MODAL AJOUT √âL√àVE -->

<div class="modal-overlay" id="modalEleve">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">üë§ Nouvel √©l√®ve</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Pr√©nom</label>
        <input class="form-input" id="inp-prenom" placeholder="Marie">
      </div>
      <div class="form-group">
        <label class="form-label">Nom</label>
        <input class="form-input" id="inp-nom" placeholder="DUPONT">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Niveau</label>
      <select class="form-input" id="inp-niveau">
        <option value="CE2">CE2</option>
        <option value="CM1">CM1</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modalEleve')">Annuler</button>
      <button class="btn-save" onclick="saveEleve()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL AJOUT COMP√âTENCE -->

<div class="modal-overlay" id="modalComp">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">üìö Nouvelle comp√©tence</div>
    <div class="form-group">
      <label class="form-label">Mati√®re</label>
      <select class="form-input" id="inp-matiere">
        <option>Sciences</option>
        <option>Anglais</option>
        <option>Fran√ßais</option>
        <option>Math√©matiques</option>
        <option>Histoire-G√©o</option>
        <option>Autre</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Comp√©tence √©valu√©e</label>
      <input class="form-input" id="inp-comp" placeholder="Ex: √âtats de l'eau">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">P√©riode</label>
        <select class="form-input" id="inp-periode">
          <option>P1</option><option>P2</option><option selected>P3</option><option>P4</option><option>P5</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Date (optionnel)</label>
        <input class="form-input" id="inp-date" type="date">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modalComp')">Annuler</button>
      <button class="btn-save" onclick="saveComp()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MENU AJOUT -->

<div class="modal-overlay" id="modalMenu">
  <div class="modal-sheet" onclick="event.stopPropagation()" style="padding-bottom:max(28px,env(safe-area-inset-bottom))">
    <div class="sheet-handle"></div>
    <button onclick="closeModal('modalMenu');openModal('modalEleve')" style="width:100%;padding:16px;border-radius:12px;border:1.5px solid var(--border);background:var(--surface);font-family:'Nunito',sans-serif;font-size:1rem;font-weight:700;color:var(--dark);cursor:pointer;margin-bottom:10px;text-align:left">
      üë§ Ajouter un √©l√®ve
    </button>
    <button onclick="closeModal('modalMenu');openModal('modalComp')" style="width:100%;padding:16px;border-radius:12px;border:1.5px solid var(--border);background:var(--surface);font-family:'Nunito',sans-serif;font-size:1rem;font-weight:700;color:var(--dark);cursor:pointer;text-align:left">
      üìö Ajouter une comp√©tence
    </button>
  </div>
</div>

<!-- TOAST -->

<div class="toast" id="toast"></div>

<!-- ============================================================
     CONFIG SUPABASE ‚Äî √Ä REMPLACER PAR VOS VRAIES VALEURS
============================================================ -->

<script>
// ‚ö†Ô∏è REMPLACEZ CES VALEURS PAR CELLES DE VOTRE PROJET SUPABASE
const SUPABASE_URL = 'VOTRE_SUPABASE_URL';
const SUPABASE_KEY = 'VOTRE_SUPABASE_ANON_KEY';
</script>

<script>
// ============================================================
// INIT SUPABASE
// ============================================================
const { createClient } = supabase;
let db;
try {
  db = createClient(SUPABASE_URL, SUPABASE_KEY);
} catch(e) {
  console.error('Supabase init error:', e);
}

// ============================================================
// STATE
// ============================================================
let eleves = [];
let competences = [];
let notes = {}; // key: "eleveId_compId" ‚Üí grade string
let currentGradeTarget = null; // {eleveId, compId}
let activeEleveFilter = 'all';
let activePeriodeFilter = 'all';
let currentUser = null;

// ============================================================
// AUTH
// ============================================================
async function init() {
  try {
    const { data: { session } } = await db.auth.getSession();
    if (session) {
      currentUser = session.user;
      await loadAll();
      showApp();
    } else {
      showLogin();
    }
  } catch(e) {
    showLogin();
  }
}

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pwd   = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');
  errEl.textContent = '';

  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password: pwd });
    if (error) throw error;
    currentUser = data.user;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loadingScreen').classList.remove('hidden');
    await loadAll();
    showApp();
  } catch(e) {
    errEl.textContent = 'Email ou mot de passe incorrect.';
    errEl.classList.remove('hidden');
  }
}

function showLogin() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
}

function showApp() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('appHeader').style.display = '';
  document.getElementById('appMain').style.display = '';
  document.getElementById('appNav').style.display = '';
  document.getElementById('fabBtn').style.display = '';
  renderAll();
}

// ============================================================
// DATA LOADING
// ============================================================
async function loadAll() {
  const uid = currentUser.id;

  const [{ data: el }, { data: co }, { data: no }] = await Promise.all([
    db.from('eleves').select('*').eq('user_id', uid).order('nom'),
    db.from('competences').select('*').eq('user_id', uid).order('created_at'),
    db.from('notes').select('*').eq('user_id', uid),
  ]);

  eleves = el || [];
  competences = co || [];
  notes = {};
  (no || []).forEach(n => { notes[`${n.eleve_id}_${n.competence_id}`] = n.grade; });
}

// ============================================================
// RENDER
// ============================================================
function renderAll() {
  renderStats();
  renderEleves();
  renderGrille();
}

function gradeColor(g) {
  return {
    'A+':'#2d6a4f','A':'#52b788','EA':'#f4a261','NA':'#e76f51','ABS':'#9ca3af'
  }[g] || '#ccc';
}

function renderStats() {
  const counts = {'A+':0,'A':0,'EA':0,'NA':0};
  Object.values(notes).forEach(g => { if(counts[g] !== undefined) counts[g]++; });
  document.getElementById('stat-aplus').textContent = counts['A+'];
  document.getElementById('stat-a').textContent     = counts['A'];
  document.getElementById('stat-ea').textContent    = counts['EA'];
  document.getElementById('stat-na').textContent    = counts['NA'];
}

function renderEleves() {
  const filtered = eleves.filter(e =>
    activeEleveFilter === 'all' || e.niveau === activeEleveFilter
  );
  const list = document.getElementById('elevesList');
  if (!filtered.length) {
    list.innerHTML = '<p style="text-align:center;color:var(--muted);padding:32px 0;font-size:0.88rem">Aucun √©l√®ve ‚Äî ajoutez-en un avec le bouton Ôºã</p>';
    return;
  }
  list.innerHTML = filtered.map(e => {
    const myNotes = competences.map(c => notes[`${e.id}_${c.id}`]).filter(Boolean);
    const scoreNum = myNotes.length ? Math.round(
      myNotes.reduce((sum, g) => sum + ({'A+':4,'A':3,'EA':2,'NA':1,'ABS':0}[g]||0), 0)
      / (myNotes.length * 4) * 100
    ) : null;
    const scoreColor = scoreNum === null ? 'var(--muted)'
      : scoreNum >= 80 ? 'var(--aplus)'
      : scoreNum >= 60 ? 'var(--a)'
      : scoreNum >= 40 ? 'var(--ea)'
      : 'var(--na)';
    const counts = {};
    myNotes.forEach(g => counts[g] = (counts[g]||0)+1);
    const miniPills = Object.entries(counts)
      .map(([g,n]) => `<span class="mini-pill" style="background:${gradeColor(g)}">${n}√ó${g}</span>`)
      .join('');
    return `<div class="eleve-card" onclick="showDetail(${e.id})">
      <div class="eleve-info">
        <div class="eleve-name">${e.prenom} ${e.nom}</div>
        <div class="eleve-sub">
          <span class="niveau-badge ${e.niveau.toLowerCase()}">${e.niveau}</span>
          ${myNotes.length} √©val.
        </div>
        ${miniPills ? `<div class="mini-grades">${miniPills}</div>` : ''}
      </div>
      <div class="eleve-score" style="color:${scoreColor}">${scoreNum !== null ? scoreNum+'%' : '‚Äî'}</div>
    </div>`;
  }).join('');
}

function renderGrille() {
  const filteredC = competences.filter(c =>
    activePeriodeFilter === 'all' || c.periode === activePeriodeFilter
  );
  const matieres = [...new Set(filteredC.map(c => c.matiere))];

  let head = '<tr>';
  head += '<th class="th-name">√âl√®ve</th>';
  matieres.forEach(m => {
    const cols = filteredC.filter(c => c.matiere === m);
    head += `<th colspan="${cols.length}" class="th-matiere">${m}</th>`;
  });
  head += '</tr><tr><th class="th-name"></th>';
  matieres.forEach(m => {
    filteredC.filter(c => c.matiere === m).forEach(c => {
      const label = c.nom.length > 10 ? c.nom.substring(0,9)+'‚Ä¶' : c.nom;
      head += `<th>${label}${c.date_eval ? `<span class="th-sub">${c.date_eval}</span>` : ''}</th>`;
    });
  });
  head += '</tr>';
  document.getElementById('grilleHead').innerHTML = head;

  let body = '';
  eleves.forEach(e => {
    const niv = e.niveau.toLowerCase();
    body += `<tr>
      <td class="td-name">
        ${e.prenom}<br>
        <span class="niveau-badge ${niv}" style="margin-top:2px">${e.niveau}</span>
      </td>`;
    filteredC.forEach(c => {
      const key = `${e.id}_${c.id}`;
      const g = notes[key];
      const cls = g ? g.replace('+','PLUS') : 'EMPTY';
      const label = g || '¬∑';
      body += `<td class="td-grade">
        <div class="grade-pill ${cls}" onclick="openGradeSheet(${e.id},${c.id},'${e.prenom} ${e.nom}','${c.nom}')">${label}</div>
      </td>`;
    });
    body += '</tr>';
  });
  document.getElementById('grilleBody').innerHTML = body;
}

function showDetail(eleveId) {
  const e = eleves.find(x => x.id === eleveId);
  if (!e) return;
  const matieres = [...new Set(competences.map(c => c.matiere))];
  let html = `
    <div style="font-size:1.2rem;font-weight:800;margin-bottom:4px">${e.prenom} ${e.nom}</div>
    <div style="margin-bottom:20px"><span class="niveau-badge ${e.niveau.toLowerCase()}">${e.niveau}</span></div>`;

  matieres.forEach(m => {
    const comps = competences.filter(c => c.matiere === m);
    html += `<div class="detail-card">
      <div class="detail-matiere">${m}</div>`;
    comps.forEach(c => {
      const g = notes[`${e.id}_${c.id}`];
      const color = g ? gradeColor(g) : '#ddd';
      html += `<div class="detail-row">
        <div class="detail-comp">${c.nom}${c.date_eval?` <span style="font-size:0.65rem;color:var(--muted)">${c.date_eval}</span>`:''}</div>
        <div class="grade-pill ${g?g.replace('+','PLUS'):'EMPTY'}" onclick="openGradeSheet(${e.id},${c.id},'${e.prenom}','${c.nom}')">${g||'¬∑'}</div>
      </div>`;
    });
    html += '</div>';
  });
  document.getElementById('detailContent').innerHTML = html;
  showScreen('detail');
}

// ============================================================
// NAVIGATION
// ============================================================
function switchNav(el, screen) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  el.classList.add('active');
  showScreen(screen);
  // Update FAB label based on screen
}
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
}

// ============================================================
// FILTERS
// ============================================================
function filterEleves(el, val) {
  document.querySelectorAll('.filter-bar .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  activeEleveFilter = val;
  renderEleves();
}
function filterPeriode(el, val) {
  el.closest('.filter-bar').querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  activePeriodeFilter = val;
  renderGrille();
}

// ============================================================
// GRADE SHEET
// ============================================================
function openGradeSheet(eleveId, compId, eleveName, compName) {
  currentGradeTarget = { eleveId, compId };
  document.getElementById('sheetTitle').textContent = `${eleveName} ‚Äî ${compName}`;
  document.getElementById('gradeOverlay').classList.add('open');
}
function closeGradeSheet() {
  document.getElementById('gradeOverlay').classList.remove('open');
  currentGradeTarget = null;
}
async function selectGrade(grade) {
  if (!currentGradeTarget) return;
  const { eleveId, compId } = currentGradeTarget;
  closeGradeSheet();
  await saveNote(eleveId, compId, grade);
}
async function saveNote(eleveId, compId, grade) {
  const key = `${eleveId}_${compId}`;
  try {
    if (grade === null) {
      await db.from('notes').delete().eq('eleve_id', eleveId).eq('competence_id', compId).eq('user_id', currentUser.id);
      delete notes[key];
      showToast('Note effac√©e');
    } else {
      const { error } = await db.from('notes').upsert({
        eleve_id: eleveId,
        competence_id: compId,
        grade,
        user_id: currentUser.id
      }, { onConflict: 'eleve_id,competence_id,user_id' });
      if (error) throw error;
      notes[key] = grade;
      showToast(`Note "${grade}" enregistr√©e ‚úì`);
    }
    renderAll();
  } catch(e) {
    showToast('Erreur lors de la sauvegarde ‚ö†Ô∏è');
    console.error(e);
  }
}

// ============================================================
// ADD MENU
// ============================================================
function openAddMenu() { openModal('modalMenu'); }

// ============================================================
// √âL√àVE
// ============================================================
async function saveEleve() {
  const prenom = document.getElementById('inp-prenom').value.trim();
  const nom    = document.getElementById('inp-nom').value.trim().toUpperCase();
  const niveau = document.getElementById('inp-niveau').value;
  if (!prenom || !nom) { showToast('Remplis pr√©nom et nom'); return; }
  try {
    const { data, error } = await db.from('eleves').insert({ prenom, nom, niveau, user_id: currentUser.id }).select().single();
    if (error) throw error;
    eleves.push(data);
    eleves.sort((a,b) => a.nom.localeCompare(b.nom));
    closeModal('modalEleve');
    document.getElementById('inp-prenom').value = '';
    document.getElementById('inp-nom').value = '';
    renderAll();
    showToast(`${prenom} ${nom} ajout√©(e) ‚úì`);
  } catch(e) {
    showToast('Erreur lors de l\'ajout ‚ö†Ô∏è');
    console.error(e);
  }
}

// ============================================================
// COMP√âTENCE
// ============================================================
async function saveComp() {
  const matiere   = document.getElementById('inp-matiere').value;
  const nom       = document.getElementById('inp-comp').value.trim();
  const periode   = document.getElementById('inp-periode').value;
  const date_eval = document.getElementById('inp-date').value || null;
  if (!nom) { showToast('Saisis le nom de la comp√©tence'); return; }
  try {
    const { data, error } = await db.from('competences').insert({ matiere, nom, periode, date_eval, user_id: currentUser.id }).select().single();
    if (error) throw error;
    competences.push(data);
    closeModal('modalComp');
    document.getElementById('inp-comp').value = '';
    renderAll();
    showToast(`"${nom}" ajout√©e ‚úì`);
  } catch(e) {
    showToast('Erreur lors de l\'ajout ‚ö†Ô∏è');
    console.error(e);
  }
}

// ============================================================
// MODALS
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ============================================================
// START
// ============================================================
init();
</script>

</body>
</html>
