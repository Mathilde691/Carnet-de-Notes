<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Carnet de Classe</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
:root {
  --bg: #f1f5f9; --surface: #ffffff; --surface2: #f8fafc;
  --dark: #0f172a; --dark2: #1e293b;
  --green: #059669; --green-dk: #047857;
  --accent: #f43f5e; --amber: #f59e0b; --indigo: #6366f1;
  --muted: #64748b; --border: #e2e8f0;
  --radius: 16px; --radius-lg: 22px;
  --aplus: #059669; --a: #10b981; --ea: #f59e0b; --na: #f43f5e; --abs: #94a3b8;
  --boy-bg: #eff6ff; --boy-border: #bfdbfe; --boy-text: #1d4ed8;
  --girl-bg: #fff0f5; --girl-border: #fbcfe8; --girl-text: #be185d;
}
html, body { height: 100%; overflow: hidden; background: var(--bg); }
body { font-family: 'Plus Jakarta Sans', sans-serif; color: var(--dark); display: flex; flex-direction: column; }

/* HEADER */
.header {
  background: var(--dark); padding: 0 16px;
  padding-top: max(0px, env(safe-area-inset-top));
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0; height: calc(56px + max(0px, env(safe-area-inset-top)));
  position: relative; overflow: hidden;
}
.header::after {
  content: ''; position: absolute; top: -30px; right: -20px;
  width: 120px; height: 120px;
  background: radial-gradient(circle, rgba(99,102,241,0.3) 0%, transparent 70%);
  pointer-events: none;
}
.header-title { display: flex; align-items: center; gap: 10px; color: white; font-size: 1.05rem; font-weight: 800; letter-spacing: -0.3px; }
.header-logo { width: 32px; height: 32px; background: linear-gradient(135deg, var(--green), var(--indigo)); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; flex-shrink: 0; }
.header-badge { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.15); font-size: 0.6rem; padding: 3px 8px; border-radius: 6px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,0.7); }
.header-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: white; border-radius: 10px; padding: 8px 14px; font-size: 0.82rem; cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; }

/* BOTTOM NAV */
.bottom-nav { background: var(--dark); display: flex; flex-shrink: 0; padding-bottom: max(6px, env(safe-area-inset-bottom)); border-top: 1px solid rgba(255,255,255,0.07); }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px 4px 6px; color: rgba(255,255,255,0.35); cursor: pointer; border: none; background: none; font-family: 'Plus Jakarta Sans', sans-serif; transition: color 0.2s; gap: 3px; position: relative; }
.nav-item.active { color: white; }
.nav-item.active::before { content: ''; position: absolute; top: 0; left: 25%; right: 25%; height: 2px; background: linear-gradient(90deg, var(--green), var(--indigo)); border-radius: 0 0 2px 2px; }
.nav-icon { font-size: 1.2rem; }
.nav-label { font-size: 0.58rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }

/* MAIN */
.main { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; background: var(--bg); }
.screen { display: none; padding: 16px 14px; }
.screen.active { display: block; }

/* SECTION TITLE */
.section-title { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.8px; color: var(--muted); margin: 18px 0 10px; }
.section-title:first-child { margin-top: 2px; }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 6px; }
.stat-card { background: var(--surface); border-radius: var(--radius); padding: 14px; display: flex; align-items: center; gap: 12px; border: 1.5px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
.stat-icon { width: 40px; height: 40px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
.stat-card.aplus .stat-icon { background: #d1fae5; }
.stat-card.a     .stat-icon { background: #d1fae5; }
.stat-card.ea    .stat-icon { background: #fef3c7; }
.stat-card.na    .stat-icon { background: #ffe4e6; }
.stat-text { display: flex; flex-direction: column; }
.stat-value { font-size: 1.7rem; font-weight: 800; line-height: 1; }
.stat-card.aplus .stat-value { color: var(--aplus); }
.stat-card.a     .stat-value { color: var(--a); }
.stat-card.ea    .stat-value { color: var(--ea); }
.stat-card.na    .stat-value { color: var(--na); }
.stat-label { font-size: 0.62rem; font-weight: 600; color: var(--muted); margin-top: 2px; }

/* FILTER */
.filter-bar { display: flex; gap: 7px; overflow-x: auto; padding-bottom: 2px; margin-bottom: 12px; scrollbar-width: none; }
.filter-bar::-webkit-scrollbar { display: none; }
.filter-chip { flex-shrink: 0; padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.75rem; font-weight: 700; color: var(--muted); cursor: pointer; }
.filter-chip.active { background: var(--dark); color: white; border-color: var(--dark); }

/* NIVEAU SEPARATOR */
.niveau-sep { display: flex; align-items: center; gap: 10px; margin: 14px 0 8px; }
.niveau-sep-line { flex: 1; height: 1px; background: var(--border); }
.niveau-sep-label { font-size: 0.62rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; padding: 3px 10px; border-radius: 20px; }
.niveau-sep-label.ce2 { background: #dbeafe; color: #1d4ed8; }
.niveau-sep-label.cm1 { background: #ede9fe; color: #7c3aed; }

/* ELEVE CARDS */
.eleve-card { border-radius: var(--radius); padding: 12px 13px; margin-bottom: 8px; display: flex; align-items: center; cursor: pointer; transition: transform 0.12s; border: 1.5px solid; position: relative; overflow: hidden; }
.eleve-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
.eleve-card.boy    { background: var(--boy-bg);  border-color: var(--boy-border);  }
.eleve-card.boy::before  { background: var(--boy-text); }
.eleve-card.girl   { background: var(--girl-bg); border-color: var(--girl-border); }
.eleve-card.girl::before { background: var(--girl-text); }
.eleve-card.unknown { background: var(--surface); border-color: var(--border); }
.eleve-card.unknown::before { background: var(--muted); }
.eleve-card:active { transform: scale(0.985); }
.eleve-avatar { width: 38px; height: 38px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; margin-right: 11px; }
.eleve-card.boy   .eleve-avatar { background: #dbeafe; }
.eleve-card.girl  .eleve-avatar { background: #fce7f3; }
.eleve-card.unknown .eleve-avatar { background: var(--surface2); }
.eleve-info { flex: 1; min-width: 0; }
.eleve-name { font-weight: 800; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.eleve-sub { font-size: 0.68rem; color: var(--muted); margin-top: 2px; display: flex; align-items: center; gap: 6px; }
.niveau-badge { font-size: 0.58rem; padding: 2px 7px; border-radius: 5px; font-weight: 800; }
.ce2 { background: #dbeafe; color: #1d4ed8; }
.cm1 { background: #ede9fe; color: #7c3aed; }
.mini-grades { display: flex; gap: 3px; margin-top: 5px; flex-wrap: wrap; }
.mini-pill { font-size: 0.58rem; font-weight: 800; padding: 2px 6px; border-radius: 5px; color: white; }
.eleve-actions { display: flex; align-items: center; gap: 4px; margin-left: 8px; flex-shrink: 0; }
.icon-btn { border: none; background: rgba(0,0,0,0.05); width: 32px; height: 32px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.icon-btn.danger { background: #fff1f2; color: var(--accent); }

/* GRILLE */
.grille-table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1.5px solid var(--border); background: var(--surface); -webkit-overflow-scrolling: touch; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
table { border-collapse: collapse; font-size: 0.72rem; }
.th-name { position: sticky; left: 0; background: var(--dark2); color: white; padding: 11px 12px; text-align: left; min-width: 115px; z-index: 10; font-weight: 800; font-size: 0.68rem; border-right: 2px solid rgba(255,255,255,0.08); }
.th-matiere { color: white; font-weight: 800; font-size: 0.62rem; letter-spacing: 0.8px; text-transform: uppercase; padding: 9px 8px 7px; text-align: center; }
.th-matiere.mat-Sciences       { background: #064e3b; }
.th-matiere.mat-Anglais        { background: #1e3a8a; }
.th-matiere.mat-Francais       { background: #4c1d95; }
.th-matiere.mat-Mathematiques  { background: #7c2d12; }
.th-matiere.mat-HistoireGeo    { background: #713f12; }
.th-matiere.mat-other          { background: #1e293b; }
.td-mat-first  { border-left: 3px solid rgba(0,0,0,0.1) !important; }
.th-mat-first  { border-left: 3px solid rgba(0,0,0,0.15) !important; }
th.th-comp { background: var(--dark2); color: rgba(255,255,255,0.75); padding: 8px 6px 9px; text-align: center; white-space: normal; font-weight: 600; font-size: 0.6rem; max-width: 68px; word-break: break-word; line-height: 1.3; border-bottom: 1px solid rgba(255,255,255,0.06); }
.th-date { font-size: 0.52rem; color: rgba(255,255,255,0.4); display: block; margin-top: 2px; font-weight: 400; }
.td-name { position: sticky; left: 0; background: var(--surface); padding: 7px 10px; font-weight: 700; font-size: 0.7rem; border-right: 2px solid var(--border); border-bottom: 1px solid var(--border); white-space: nowrap; z-index: 5; }
.td-name.boy-row  { background: var(--boy-bg); }
.td-name.girl-row { background: var(--girl-bg); }
.td-grade { padding: 5px 4px; text-align: center; border-bottom: 1px solid var(--border); vertical-align: middle; }
.tr-niveau-sep td { background: var(--bg); padding: 4px 12px; font-size: 0.58rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); border-bottom: 1px solid var(--border); }

/* GRADE PILLS */
.grade-pill { display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 24px; border-radius: 7px; font-size: 0.62rem; font-weight: 800; cursor: pointer; transition: transform 0.1s; letter-spacing: 0.3px; }
.grade-pill:active { transform: scale(0.88); }
.grade-pill.APLUS { background: var(--aplus); color: white; }
.grade-pill.A     { background: var(--a);     color: white; }
.grade-pill.EA    { background: var(--ea);    color: white; }
.grade-pill.NA    { background: var(--na);    color: white; }
.grade-pill.ABS   { background: var(--abs);   color: white; }
.grade-pill.EMPTY { background: #f1f5f9; color: #cbd5e1; border: 1.5px dashed #e2e8f0; font-size: 0.75rem; }

/* BOTTOM SHEET / OVERLAY */
.overlay { display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.6); z-index: 100; align-items: flex-end; backdrop-filter: blur(4px); }
.overlay.open { display: flex; }
.bottom-sheet { background: var(--surface); border-radius: 24px 24px 0 0; padding: 16px 18px; padding-bottom: max(24px, env(safe-area-inset-bottom)); width: 100%; animation: slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.sheet-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 14px; }
.sheet-title { font-size: 0.78rem; font-weight: 800; margin-bottom: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.grade-options { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px; }
.grade-option-btn { padding: 14px 4px 10px; border-radius: 14px; border: none; color: white; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1rem; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: transform 0.1s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.grade-option-btn:active { transform: scale(0.93); }
.grade-desc { font-size: 0.52rem; font-weight: 600; opacity: 0.85; line-height: 1.2; text-align: center; }
.grade-option-btn.APLUS { background: linear-gradient(135deg, #059669, #047857); }
.grade-option-btn.A     { background: linear-gradient(135deg, #10b981, #059669); }
.grade-option-btn.EA    { background: linear-gradient(135deg, #f59e0b, #d97706); }
.grade-option-btn.NA    { background: linear-gradient(135deg, #f43f5e, #e11d48); }
.grade-option-btn.ABS   { background: linear-gradient(135deg, #94a3b8, #64748b); }
.btn-erase { width: 100%; padding: 13px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.88rem; font-weight: 700; color: var(--muted); cursor: pointer; margin-top: 4px; }

/* MODALS */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.6); z-index: 200; align-items: flex-end; backdrop-filter: blur(4px); }
.modal-overlay.open { display: flex; }
.modal-sheet { background: var(--surface); border-radius: 24px 24px 0 0; padding: 20px 18px; padding-bottom: max(28px, env(safe-area-inset-bottom)); width: 100%; max-height: 92vh; overflow-y: auto; animation: slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1); }
.modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 18px; letter-spacing: -0.3px; }
.form-group { margin-bottom: 12px; }
.form-label { display: block; font-size: 0.66rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 6px; }
.form-input { width: 100%; padding: 12px 14px; border: 1.5px solid var(--border); border-radius: 10px; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.95rem; background: var(--surface2); color: var(--dark); -webkit-appearance: none; }
.form-input:focus { outline: none; border-color: var(--green); background: white; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.modal-actions { display: flex; gap: 10px; margin-top: 18px; }
.btn-cancel { flex: 1; padding: 13px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.88rem; font-weight: 700; cursor: pointer; color: var(--muted); }
.btn-save { flex: 2; padding: 13px; border-radius: 10px; border: none; background: linear-gradient(135deg, var(--green), var(--green-dk)); color: white; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.88rem; font-weight: 800; cursor: pointer; box-shadow: 0 4px 14px rgba(5,150,105,0.35); }

/* GENRE TOGGLE */
.genre-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.genre-btn { padding: 11px 8px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--surface2); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.82rem; font-weight: 700; cursor: pointer; text-align: center; color: var(--muted); }
.genre-btn.selected-boy  { background: var(--boy-bg);  border-color: var(--boy-border);  color: var(--boy-text); }
.genre-btn.selected-girl { background: var(--girl-bg); border-color: var(--girl-border); color: var(--girl-text); }
.genre-btn.selected-unknown { background: var(--dark); border-color: var(--dark); color: white; }

/* DETAIL ELEVE */
.back-btn { display: flex; align-items: center; gap: 6px; color: var(--green); font-weight: 700; font-size: 0.85rem; cursor: pointer; margin-bottom: 14px; border: none; background: none; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
.detail-header { background: var(--surface); border-radius: var(--radius); border: 1.5px solid var(--border); padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px; }
.detail-avatar { width: 52px; height: 52px; border-radius: 15px; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.detail-avatar.boy     { background: var(--boy-bg); }
.detail-avatar.girl    { background: var(--girl-bg); }
.detail-avatar.unknown { background: var(--surface2); }
.detail-name { font-size: 1.1rem; font-weight: 800; }
.detail-meta { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
.detail-card { background: var(--surface); border-radius: var(--radius); border: 1.5px solid var(--border); margin-bottom: 10px; overflow: hidden; box-shadow: 0 1px 6px rgba(0,0,0,0.04); }
.detail-matiere-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
.detail-matiere-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.2px; color: var(--muted); }
.detail-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
.detail-row:last-child { border-bottom: none; }
.detail-comp { font-size: 0.83rem; font-weight: 600; flex: 1; padding-right: 10px; line-height: 1.3; }
.detail-comp-date { font-size: 0.6rem; color: var(--muted); display: block; margin-top: 2px; }

/* MENU BTN */
.menu-btn { width: 100%; padding: 15px 16px; border-radius: 14px; border: 1.5px solid var(--border); background: var(--surface2); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.95rem; font-weight: 700; color: var(--dark); cursor: pointer; text-align: left; display: flex; align-items: center; gap: 12px; }
.menu-btn:active { background: var(--border); }
.menu-btn-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }

/* FAB */

/* TOAST */
.toast { position: fixed; bottom: calc(76px + max(6px, env(safe-area-inset-bottom))); left: 14px; right: 14px; background: var(--dark2); color: white; padding: 12px 16px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; z-index: 300; transform: translateY(20px); opacity: 0; transition: all 0.25s; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
.toast.show { transform: translateY(0); opacity: 1; }

/* LOADING / LOGIN */
.loading-screen { position: fixed; inset: 0; background: var(--dark); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; z-index: 1000; color: white; }
.loading-screen.hidden { display: none; }
.loading-logo { width: 64px; height: 64px; background: linear-gradient(135deg, var(--green), var(--indigo)); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 4px; }
.spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,0.15); border-top-color: var(--green); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-title { font-size: 1.1rem; font-weight: 800; }
.loading-sub   { font-size: 0.75rem; opacity: 0.5; }
.login-screen { position: fixed; inset: 0; background: var(--dark); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 24px; gap: 14px; z-index: 900; background-image: radial-gradient(ellipse at 20% 20%, rgba(99,102,241,0.15) 0%, transparent 60%), radial-gradient(ellipse at 80% 80%, rgba(5,150,105,0.12) 0%, transparent 60%); }
.login-screen.hidden { display: none; }
.login-logo-wrap { width: 72px; height: 72px; background: linear-gradient(135deg, var(--green), var(--indigo)); border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; margin-bottom: 6px; box-shadow: 0 12px 40px rgba(99,102,241,0.3); }
.login-title { color: white; font-size: 1.5rem; font-weight: 800; text-align: center; }
.login-sub { color: rgba(255,255,255,0.45); font-size: 0.8rem; text-align: center; margin-bottom: 8px; }
.login-input { width: 100%; max-width: 320px; padding: 14px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.95rem; background: rgba(255,255,255,0.07); color: white; -webkit-appearance: none; }
.login-input::placeholder { color: rgba(255,255,255,0.3); }
.login-input:focus { outline: none; background: rgba(255,255,255,0.12); }
.login-btn { width: 100%; max-width: 320px; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--green), var(--indigo)); color: white; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.95rem; font-weight: 800; cursor: pointer; margin-top: 4px; }
.login-error { color: #fda4af; font-size: 0.8rem; font-weight: 700; }

.icon-btn.edit { background: #f0fdf4; color: var(--green); }
.hidden { display: none !important; }
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">üåø</div>
  <div class="spinner"></div>
  <div class="loading-title">Carnet de Classe</div>
  <div class="loading-sub">Chargement en cours‚Ä¶</div>
</div>

<!-- LOGIN -->
<div class="login-screen hidden" id="loginScreen">
  <div class="login-logo-wrap">üåø</div>
  <div class="login-title">Carnet de Classe</div>
  <div class="login-sub">CE2 ¬∑ CM1 ‚Äî Espace enseignant</div>
  <input class="login-input" id="loginEmail" type="email" placeholder="votre@email.com" autocomplete="email">
  <input class="login-input" id="loginPassword" type="password" placeholder="Mot de passe" autocomplete="current-password">
  <button class="login-btn" onclick="doLogin()">Se connecter ‚Üí</button>
  <div class="login-error hidden" id="loginError"></div>
</div>

<!-- HEADER -->
<div class="header" id="appHeader" style="display:none">
  <div class="header-title">
    <div class="header-logo">üåø</div>
    Carnet <span class="header-badge">CE2 ¬∑ CM1</span>
  </div>
  <button class="header-btn" onclick="openAddMenu()">Ôºã Ajouter</button>
</div>

<!-- MAIN -->
<div class="main" id="appMain" style="display:none">

  <!-- ACCUEIL -->
  <div class="screen active" id="screen-accueil">
    <div class="section-title">Tableau de bord</div>
    <div class="stats-grid">
      <div class="stat-card aplus"><div class="stat-icon">üèÜ</div><div class="stat-text"><div class="stat-value" id="stat-aplus">‚Äî</div><div class="stat-label">A+ D√©pass√©e</div></div></div>
      <div class="stat-card a"><div class="stat-icon">‚úÖ</div><div class="stat-text"><div class="stat-value" id="stat-a">‚Äî</div><div class="stat-label">A Acquis</div></div></div>
      <div class="stat-card ea"><div class="stat-icon">üìà</div><div class="stat-text"><div class="stat-value" id="stat-ea">‚Äî</div><div class="stat-label">EA En cours</div></div></div>
      <div class="stat-card na"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-text"><div class="stat-value" id="stat-na">‚Äî</div><div class="stat-label">NA Non acquis</div></div></div>
    </div>
    <div class="section-title">√âl√®ves</div>
    <div class="filter-bar">
      <button class="filter-chip active" onclick="filterEleves(this,'all')">Tous</button>
      <button class="filter-chip" onclick="filterEleves(this,'CE2')">CE2</button>
      <button class="filter-chip" onclick="filterEleves(this,'CM1')">CM1</button>
      <button class="filter-chip" onclick="filterEleves(this,'F')">üëß Filles</button>
      <button class="filter-chip" onclick="filterEleves(this,'M')">üë¶ Gar√ßons</button>
    </div>
    <div id="elevesList"></div>
  </div>

  <!-- GRILLE -->
  <div class="screen" id="screen-grille">
    <div class="section-title">P√©riode</div>
    <div class="filter-bar">
      <button class="filter-chip active" onclick="filterPeriode(this,'all')">Toutes</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P1')">P1</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P2')">P2</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P3')">P3</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P4')">P4</button>
      <button class="filter-chip" onclick="filterPeriode(this,'P5')">P5</button>
      <button class="filter-chip" onclick="openEditGrille(this)" id="chip-edit-grille" style="border-color:var(--indigo);color:var(--indigo)">‚úèÔ∏è √âditer</button>
    </div>
    <!-- PANEL √âDITION GRILLE -->
    <div id="editGrillePanel" style="display:none;background:var(--surface);border-radius:var(--radius);border:1.5px solid var(--border);padding:14px;margin-bottom:14px">
      <div style="font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px">G√©rer mati√®res &amp; comp√©tences</div>
      <div id="editGrilleContent"></div>
    </div>
    <div class="grille-table-wrap">
      <table id="grilleTable">
        <thead id="grilleHead"></thead>
        <tbody id="grilleBody"></tbody>
      </table>
    </div>
  </div>

  <!-- DETAIL -->
  <div class="screen" id="screen-detail">
    <button class="back-btn" onclick="showScreen('accueil')">‚Üê Retour √† la liste</button>
    <div id="detailContent"></div>
  </div>

</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav" id="appNav" style="display:none">
  <button class="nav-item active" onclick="switchNav(this,'accueil')"><span class="nav-icon">üè†</span><span class="nav-label">Accueil</span></button>
  <button class="nav-item" onclick="switchNav(this,'grille')"><span class="nav-icon">üìä</span><span class="nav-label">Grille</span></button>
</div>


<!-- GRADE SHEET -->
<div class="overlay" id="gradeOverlay" onclick="closeGradeSheet()">
  <div class="bottom-sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">Choisir une note</div>
    <div class="grade-options">
      <button class="grade-option-btn APLUS" onclick="selectGrade('A+')">A+<span class="grade-desc">D√©pass√©e</span></button>
      <button class="grade-option-btn A"     onclick="selectGrade('A')">A<span class="grade-desc">Acquis</span></button>
      <button class="grade-option-btn EA"    onclick="selectGrade('EA')">EA<span class="grade-desc">En cours</span></button>
      <button class="grade-option-btn NA"    onclick="selectGrade('NA')">NA<span class="grade-desc">Non acquis</span></button>
      <button class="grade-option-btn ABS"   onclick="selectGrade('ABS')">ABS<span class="grade-desc">Absent</span></button>
    </div>
    <button class="btn-erase" onclick="selectGrade(null)">‚úï Effacer la note</button>
  </div>
</div>

<!-- MODAL ELEVE -->
<div class="modal-overlay" id="modalEleve">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">üë§ Nouvel √©l√®ve</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="inp-prenom" placeholder="Marie"></div>
      <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="inp-nom" placeholder="DUPONT"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Niveau</label>
      <select class="form-input" id="inp-niveau"><option value="CE2">CE2</option><option value="CM1">CM1</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">Genre</label>
      <div class="genre-toggle">
        <button type="button" class="genre-btn" id="genre-boy" onclick="selectGenre('M')">üë¶ Gar√ßon</button>
        <button type="button" class="genre-btn" id="genre-girl" onclick="selectGenre('F')">üëß Fille</button>

      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modalEleve');openModal('modalMenu')">‚Üê Retour</button>
      <button class="btn-save" onclick="saveEleve()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL COMP -->
<div class="modal-overlay" id="modalComp">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">üìö Nouvelle comp√©tence</div>
    <div class="form-group">
      <label class="form-label">Mati√®re</label>
      <select class="form-input" id="inp-matiere" onchange="onMatiereChange()">
        <option>Sciences</option><option>Anglais</option><option>Fran√ßais</option>
        <option>Math√©matiques</option><option>Histoire-G√©o</option><option>Autre</option>
      </select>
    </div>
    <div class="form-group hidden" id="matiereCustomWrap">
      <label class="form-label">Nouvelle mati√®re</label>
      <input class="form-input" id="inp-matiere-custom" placeholder="Ex: EPS, Arts plastiques...">
    </div>
    <div class="form-group">
      <label class="form-label">Comp√©tence √©valu√©e</label>
      <input class="form-input" id="inp-comp" type="text" placeholder="Ex: √âtats de l'eau" autocomplete="off" autocapitalize="sentences">
    </div>
    <div class="form-group">
      <label class="form-label">P√©riodes</label>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px" id="comp-periodes-grid">
        <button type="button" class="genre-btn" id="comp-p1" onclick="toggleCompPeriode('P1')">P1</button>
        <button type="button" class="genre-btn" id="comp-p2" onclick="toggleCompPeriode('P2')">P2</button>
        <button type="button" class="genre-btn selected-unknown" id="comp-p3" onclick="toggleCompPeriode('P3')">P3</button>
        <button type="button" class="genre-btn" id="comp-p4" onclick="toggleCompPeriode('P4')">P4</button>
        <button type="button" class="genre-btn" id="comp-p5" onclick="toggleCompPeriode('P5')">P5</button>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Date (optionnel)</label><input class="form-input" id="inp-date" type="date"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modalComp');openModal('modalMenu')">‚Üê Retour</button>
      <button class="btn-save" onclick="saveComp()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL MODIFIER √âL√àVE -->
<div class="modal-overlay" id="modalEditEleve">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">‚úèÔ∏è Modifier l'√©l√®ve</div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="edit-prenom" placeholder="Marie"></div>
      <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="edit-nom" placeholder="DUPONT"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Niveau</label>
      <select class="form-input" id="edit-niveau"><option value="CE2">CE2</option><option value="CM1">CM1</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">Genre</label>
      <div class="genre-toggle">
        <button type="button" class="genre-btn" id="edit-genre-boy" onclick="selectEditGenre('M')">üë¶ Gar√ßon</button>
        <button type="button" class="genre-btn" id="edit-genre-girl" onclick="selectEditGenre('F')">üëß Fille</button>

      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modalEditEleve')">Annuler</button>
      <button class="btn-save" onclick="updateEleve()">Enregistrer les modifications</button>
    </div>
  </div>
</div>

<!-- MENU AJOUT -->
<div class="modal-overlay" id="modalMenu">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <button class="menu-btn" onclick="closeModal('modalMenu');openModal('modalEleve')" style="margin-bottom:8px">
      <div class="menu-btn-icon" style="background:#eff6ff">üë§</div>
      <div><div>Ajouter un √©l√®ve</div><div style="font-size:0.72rem;font-weight:500;color:var(--muted);margin-top:2px">Pr√©nom, nom, niveau, genre</div></div>
    </button>
    <button class="menu-btn" onclick="closeModal('modalMenu');openCompModal()" style="margin-bottom:16px">
      <div class="menu-btn-icon" style="background:#f0fdf4">üìö</div>
      <div><div>Ajouter une comp√©tence</div><div style="font-size:0.72rem;font-weight:500;color:var(--muted);margin-top:2px">Mati√®re, libell√©, p√©riode</div></div>
    </button>

    <button onclick="closeModal('modalMenu')" style="width:100%;padding:13px;border-radius:10px;border:1.5px solid var(--border);background:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:0.88rem;font-weight:700;color:var(--muted);cursor:pointer;">
      ‚úï Retour √† l'accueil
    </button>
  </div>
</div>


<!-- MODAL DUPLIQUER MATI√àRE -->
<div class="modal-overlay" id="modalMatiere">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">üìã Dupliquer une mati√®re</div>
    <div class="form-group">
      <label class="form-label">Mati√®re √† dupliquer</label>
      <select class="form-input" id="dup-matiere" onchange="onDupMatiereChange()">
      </select>
    </div>
    <div class="form-group hidden" id="dupMatiereCustomWrap">
      <label class="form-label">Nouvelle mati√®re</label>
      <input class="form-input" id="dup-matiere-custom" placeholder="Ex: EPS, Arts plastiques...">
    </div>
    <div class="form-group">
      <label class="form-label">P√©riodes cibles</label>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:2px" id="dup-periodes-grid">
        <button type="button" class="genre-btn selected-unknown" id="dup-p1" onclick="toggleDupPeriode('P1')">P1</button>
        <button type="button" class="genre-btn selected-unknown" id="dup-p2" onclick="toggleDupPeriode('P2')">P2</button>
        <button type="button" class="genre-btn selected-unknown" id="dup-p3" onclick="toggleDupPeriode('P3')">P3</button>
        <button type="button" class="genre-btn selected-unknown" id="dup-p4" onclick="toggleDupPeriode('P4')">P4</button>
        <button type="button" class="genre-btn selected-unknown" id="dup-p5" onclick="toggleDupPeriode('P5')">P5</button>
      </div>
    </div>
    <div class="form-group" style="margin-top:10px">
      <label class="form-label">Comp√©tence √† ajouter <span style="font-weight:500;text-transform:none;letter-spacing:0;color:#94a3b8">(optionnel)</span></label>
      <input class="form-input" id="dup-comp" type="text" placeholder="Laisser vide = mati√®re seule" autocomplete="off" autocapitalize="sentences">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modalMatiere');openModal('modalMenu')">‚Üê Retour</button>
      <button class="btn-save" onclick="dupMatiere()">Dupliquer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ö†Ô∏è REMPLACEZ CES VALEURS PAR CELLES DE VOTRE PROJET SUPABASE
const SUPABASE_URL = 'https://jwajdkdtkcgemxhejumb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_klKLwvVxWb8LcIOjGIl9tw_3Uj8C4f4';
</script>

<script>
const { createClient } = supabase;
let db;
try { db = createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }

let eleves = [], competences = [], notes = {};
let currentGradeTarget = null, activeEleveFilter = 'all', activePeriodeFilter = 'all';
let currentUser = null, selectedGenre = '';

// AUTH
async function init() {
  try {
    const { data: { session } } = await db.auth.getSession();
    if (session) { currentUser = session.user; await loadAll(); showApp(); }
    else showLogin();
  } catch(e) { showLogin(); }
}
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pwd = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.classList.add('hidden'); errEl.textContent = '';
  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password: pwd });
    if (error) throw error;
    currentUser = data.user;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('loadingScreen').classList.remove('hidden');
    await loadAll(); showApp();
  } catch(e) { errEl.textContent = 'Email ou mot de passe incorrect.'; errEl.classList.remove('hidden'); }
}
function showLogin() { document.getElementById('loadingScreen').classList.add('hidden'); document.getElementById('loginScreen').classList.remove('hidden'); }
function showApp() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
  ['appHeader','appMain','appNav',].forEach(id => document.getElementById(id).style.display = '');
  renderAll();
}

// DATA
async function loadAll() {
  const uid = currentUser.id;
  const [{ data: el }, { data: co }, { data: no }] = await Promise.all([
    db.from('eleves').select('*').eq('user_id', uid).order('nom'),
    db.from('competences').select('*').eq('user_id', uid).order('created_at'),
    db.from('notes').select('*').eq('user_id', uid),
  ]);
  eleves = el || []; competences = co || []; notes = {};
  (no || []).forEach(n => { notes[`${n.eleve_id}_${n.competence_id}`] = n.grade; });
}
async function quickRefresh() {
  try {
    await loadAll();
    renderAll();
    refreshMatiereSelect();
    if (typeof editGrilleOpen !== 'undefined' && editGrilleOpen) renderEditGrille();
    if (document.getElementById('screen-detail')?.classList.contains('active') && window.currentDetailEleveId)
      showDetail(window.currentDetailEleveId);
  } catch(e) {
    console.error('quickRefresh error:', e);
    // Tenter un re-render m√™me en cas d'erreur
    try { renderAll(); } catch(e2) {}
  }
}

// RENDER
function renderAll() { renderStats(); renderEleves(); renderGrille(); }
function gradeColor(g) { return {'A+':'#059669','A':'#10b981','EA':'#f59e0b','NA':'#f43f5e','ABS':'#94a3b8'}[g]||'#ccc'; }
function gc(sexe) { return sexe==='M'?'boy':sexe==='F'?'girl':'unknown'; }
function ge(sexe) { return sexe==='M'?'üë¶':sexe==='F'?'üëß':'üßë'; }

function renderStats() {
  const c = {'A+':0,'A':0,'EA':0,'NA':0};
  Object.values(notes).forEach(g => { if(c[g]!==undefined) c[g]++; });
  ['aplus','a','ea','na'].forEach((k,i)=>{ document.getElementById('stat-'+k).textContent = c[['A+','A','EA','NA'][i]]; });
}

function sortedEleves(filter) {
  return eleves.filter(e=>{
    if(filter==='all') return true;
    if(filter==='M' || filter==='F') return e.sexe===filter;
    return e.niveau===filter;
  }).sort((a,b)=>{ if(a.niveau!==b.niveau) return a.niveau==='CE2'?-1:1; return a.nom.localeCompare(b.nom); });
}

function renderEleves() {
  const filtered = sortedEleves(activeEleveFilter);
  const list = document.getElementById('elevesList');
  if (!filtered.length) { list.innerHTML='<p style="text-align:center;color:var(--muted);padding:40px 0;font-size:0.85rem">Aucun √©l√®ve ‚Äî appuyez sur Ôºã pour en ajouter un</p>'; return; }
  let html = '', lastNiv = null;
  filtered.forEach(e => {
    if ((activeEleveFilter==='all'||activeEleveFilter==='M'||activeEleveFilter==='F') && e.niveau!==lastNiv) {
      lastNiv = e.niveau;
      html += `<div class="niveau-sep"><div class="niveau-sep-line"></div><span class="niveau-sep-label ${e.niveau.toLowerCase()}">${e.niveau}</span><div class="niveau-sep-line"></div></div>`;
    }
    const myNotes = competences.map(c=>notes[`${e.id}_${c.id}`]).filter(Boolean);
    const counts = {}; myNotes.forEach(g=>counts[g]=(counts[g]||0)+1);
    const pills = Object.entries(counts).map(([g,n])=>`<span class="mini-pill" style="background:${gradeColor(g)}">${n}√ó${g}</span>`).join('');
    html += `<div class="eleve-card ${gc(e.sexe)}" onclick="showDetail(${e.id})">
      <div class="eleve-avatar ${gc(e.sexe)}">${ge(e.sexe)}</div>
      <div class="eleve-info">
        <div class="eleve-name">${e.prenom} <span style="font-weight:600">${e.nom}</span></div>
        <div class="eleve-sub"><span class="niveau-badge ${e.niveau.toLowerCase()}">${e.niveau}</span>${myNotes.length} √©val.</div>
        ${pills?`<div class="mini-grades">${pills}</div>`:''}
      </div>
      <div class="eleve-actions">
        <button class="icon-btn edit" onclick="event.stopPropagation();openEditEleve(${e.id})">‚úèÔ∏è</button>
        <button class="icon-btn danger" onclick="event.stopPropagation();deleteEleve(${e.id})">üóëÔ∏è</button>
      </div>
    </div>`;
  });
  list.innerHTML = html;
}

function matiereClass(m) {
  return {'Sciences':'mat-Sciences','Anglais':'mat-Anglais','Fran√ßais':'mat-Francais','Math√©matiques':'mat-Mathematiques','Histoire-G√©o':'mat-HistoireGeo'}[m]||'mat-other';
}

function renderGrille() {
  const filteredC = competences.filter(c=>activePeriodeFilter==='all'||c.periode===activePeriodeFilter);
  const matieres = [...new Set(filteredC.map(c=>c.matiere))];
  // HEAD row 1
  let head = `<tr><th class="th-name" rowspan="2">√âl√®ve</th>`;
  matieres.forEach((m,mi)=>{
    const cols = filteredC.filter(c=>c.matiere===m);
    head += `<th colspan="${cols.length}" class="th-matiere ${matiereClass(m)}${mi>0?' th-mat-first':''}">${m}</th>`;
  });
  head += '</tr><tr>';
  matieres.forEach((m,mi)=>{
    filteredC.filter(c=>c.matiere===m).forEach((c,ci)=>{
      const label = c.nom.length>12?c.nom.substring(0,11)+'‚Ä¶':c.nom;
      const isFirst = ci===0&&mi>0;
      head += `<th class="th-comp${isFirst?' th-mat-first':''}" title="${c.nom}">${label}${c.date_eval?`<span class="th-date">${c.date_eval}</span>`:''}</th>`;
    });
  });
  head += '</tr>';
  document.getElementById('grilleHead').innerHTML = head;
  // BODY
  const sorted = [...eleves].sort((a,b)=>{ if(a.niveau!==b.niveau) return a.niveau==='CE2'?-1:1; return a.nom.localeCompare(b.nom); });
  let body = '', lastNiv = null;
  sorted.forEach(e=>{
    if (e.niveau!==lastNiv) {
      lastNiv=e.niveau;
      body+=`<tr class="tr-niveau-sep"><td colspan="${1+filteredC.length}">${e.niveau}</td></tr>`;
    }
    body+=`<tr><td class="td-name ${gc(e.sexe)}-row">${ge(e.sexe)} ${e.prenom}<br><span class="niveau-badge ${e.niveau.toLowerCase()}">${e.niveau}</span></td>`;
    matieres.forEach((m,mi)=>{
      filteredC.filter(c=>c.matiere===m).forEach((c,ci)=>{
        const key=`${e.id}_${c.id}`, g=notes[key];
        const cls=g?g.replace('+','PLUS'):'EMPTY';
        const isFirst=ci===0&&mi>0;
        body+=`<td class="td-grade${isFirst?' td-mat-first':''}"><div class="grade-pill ${cls}" onclick="openGradeSheet(${e.id},${c.id},'${e.prenom} ${e.nom}','${(c.nom||'').replace(/'/g,"\\'")}')">${g||'¬∑'}</div></td>`;
      });
    });
    body+='</tr>';
  });
  document.getElementById('grilleBody').innerHTML = body;
}

function showDetail(eleveId) {
  window.currentDetailEleveId = eleveId;
  const e = eleves.find(x=>x.id===eleveId); if(!e) return;
  const matieres = [...new Set(competences.map(c=>c.matiere))];
  let html = `<div class="detail-header">
    <div class="detail-avatar ${gc(e.sexe)}">${ge(e.sexe)}</div>
    <div><div class="detail-name">${e.prenom} ${e.nom}</div>
    <div class="detail-meta"><span class="niveau-badge ${e.niveau.toLowerCase()}">${e.niveau}</span>
    <span style="font-size:0.72rem;color:var(--muted)">${e.sexe==='M'?'Gar√ßon':e.sexe==='F'?'Fille':''}</span></div></div>
    <button onclick="deleteEleve(${e.id})" class="icon-btn danger" style="margin-left:auto">üóëÔ∏è</button>
  </div>`;
  matieres.forEach(m=>{
    const comps=competences.filter(c=>c.matiere===m).sort((a,b)=>a.periode.localeCompare(b.periode)), safeM=m.replace(/'/g,"\\'");
    html+=`<div class="detail-card"><div class="detail-matiere-header"><div class="detail-matiere-label">${m}</div><button onclick="deleteMatiere('${safeM}')" class="icon-btn danger" style="width:28px;height:28px;font-size:0.75rem">üóëÔ∏è</button></div>`;
    comps.forEach(c=>{
      const g=notes[`${e.id}_${c.id}`];
      html+=`<div class="detail-row"><div class="detail-comp">${c.nom !== '(mati√®re)' ? c.nom : ''}${c.date_eval?`<span class="detail-comp-date">üìÖ ${c.date_eval}</span>`:''}<span style="font-size:0.62rem;font-weight:800;background:var(--bg);color:var(--muted);padding:1px 7px;border-radius:5px;margin-left:6px">${c.periode}</span></div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="grade-pill ${g?g.replace('+','PLUS'):'EMPTY'}" onclick="openGradeSheet(${e.id},${c.id},'${e.prenom}','${(c.nom||'').replace(/'/g,"\\'")}')">${g||'¬∑'}</div>
        <button onclick="deleteCompetence(${c.id})" class="icon-btn danger" style="width:28px;height:28px;font-size:0.75rem">üóëÔ∏è</button>
      </div></div>`;
    });
    html+='</div>';
  });
  document.getElementById('detailContent').innerHTML = html;
  showScreen('detail');
}

// NAV
function switchNav(el, screen) { document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); showScreen(screen); }
function showScreen(name) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(`screen-${name}`).classList.add('active'); }
function filterEleves(el, val) { el.closest('.filter-bar').querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); activeEleveFilter=val; renderEleves(); }
function filterPeriode(el, val) { el.closest('.filter-bar').querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); activePeriodeFilter=val; renderGrille(); }

// GRADE SHEET
function openGradeSheet(eleveId, compId, eleveName, compName) { currentGradeTarget={eleveId,compId}; document.getElementById('sheetTitle').textContent=`${eleveName} ‚Äî ${compName}`; document.getElementById('gradeOverlay').classList.add('open'); }
function closeGradeSheet() { document.getElementById('gradeOverlay').classList.remove('open'); currentGradeTarget=null; }
async function selectGrade(grade) { if(!currentGradeTarget) return; const {eleveId,compId}=currentGradeTarget; closeGradeSheet(); await saveNote(eleveId,compId,grade); }
async function saveNote(eleveId, compId, grade) {
  const key=`${eleveId}_${compId}`;
  try {
    if (grade===null) {
      await db.from('notes').delete().eq('eleve_id',eleveId).eq('competence_id',compId).eq('user_id',currentUser.id);
      delete notes[key]; showToast('Note effac√©e');
    } else {
      const {error}=await db.from('notes').upsert({eleve_id:eleveId,competence_id:compId,grade,user_id:currentUser.id},{onConflict:'eleve_id,competence_id,user_id'});
      if(error) throw error; notes[key]=grade; showToast(`Note "${grade}" enregistr√©e ‚úì`);
    }
    await quickRefresh();
  } catch(e) { showToast('Erreur sauvegarde ‚ö†Ô∏è'); console.error(e); }
}

// GENRE
function selectGenre(val) {
  // Si val vide (ancien enregistrement sans genre), on force M par d√©faut
  if(val === '' || val === null || val === undefined) val = 'M';
  selectedGenre=val;
  document.getElementById('genre-boy').className='genre-btn'+(val==='M'?' selected-boy':'');
  document.getElementById('genre-girl').className='genre-btn'+(val==='F'?' selected-girl':'');
}

// ADD
function openAddMenu() { openModal('modalMenu'); }
async function saveEleve() {
  const prenom=document.getElementById('inp-prenom').value.trim();
  const nom=document.getElementById('inp-nom').value.trim().toUpperCase();
  const niveau=document.getElementById('inp-niveau').value;
  const sexe=selectedGenre||'M';
  if(!prenom||!nom){showToast('Remplis pr√©nom et nom');return;}

  const btn=document.querySelector('#modalEleve .btn-save');
  if(btn){btn.disabled=true;btn.textContent='Enregistrement...';}

  try {
    const {error}=await db.from('eleves').insert({prenom,nom,niveau,sexe,user_id:currentUser.id});
    if(error) throw error;
    // Fermer et r√©initialiser
    closeModal('modalEleve');
    document.getElementById('inp-prenom').value='';
    document.getElementById('inp-nom').value='';
    selectGenre('M');
    showToast(`${prenom} ${nom} ajout√©(e) ‚úì`);
    // Rafra√Æchir en arri√®re-plan
    await quickRefresh();
  } catch(e){
    showToast("Erreur : "+e.message);
    console.error(e);
  } finally {
    if(btn){btn.disabled=false;btn.textContent='Enregistrer';}
  }
}
async function saveComp() {
  let matiere=document.getElementById('inp-matiere').value;
  const custom=(document.getElementById('inp-matiere-custom')?.value||'').trim();
  if(matiere==='Autre'){if(!custom){showToast('Saisis une mati√®re');return;} matiere=custom;}
  const nom=document.getElementById('inp-comp').value.trim();
  const date_eval=document.getElementById('inp-date').value||null;
  if(!nom){showToast('Saisis le nom de la comp√©tence');return;}
  if(compPeriodes.size===0){showToast('S√©lectionne au moins une p√©riode');return;}

  const btn=document.querySelector('#modalComp .btn-save');
  if(btn){btn.disabled=true;btn.textContent='Enregistrement...';}

  try {
    const existantes=new Set(competences.filter(c=>c.matiere===matiere&&c.nom===nom).map(c=>c.periode));
    const aInserer=[...compPeriodes].filter(p=>!existantes.has(p));
    if(aInserer.length===0){showToast('Cette comp√©tence existe d√©j√† dans les p√©riodes s√©lectionn√©es');return;}
    const rows=aInserer.map(p=>({matiere,nom,periode:p,date_eval,user_id:currentUser.id}));
    const {error}=await db.from('competences').insert(rows);
    if(error) throw error;
    // Fermer et r√©initialiser
    closeModal('modalComp');
    document.getElementById('inp-comp').value='';
    document.getElementById('inp-date').value='';
    if(document.getElementById('inp-matiere-custom')) document.getElementById('inp-matiere-custom').value='';
    document.getElementById('matiereCustomWrap').classList.add('hidden');
    const label=aInserer.length===1?aInserer[0]:aInserer.join(', ');
    showToast(`"${nom}" ajout√©e sur ${label} ‚úì`);
    // Rafra√Æchir en arri√®re-plan
    await quickRefresh();
  } catch(e){
    showToast("Erreur : "+e.message);
    console.error(e);
  } finally {
    if(btn){btn.disabled=false;btn.textContent='Enregistrer';}
  }
}


// MODALS

function openCompModal() {
  refreshMatiereSelect();
  document.getElementById('inp-comp').value = '';
  document.getElementById('inp-date').value = '';
  initCompPeriodes();
  openModal('modalComp');
}

function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function refreshMatiereSelect() {
  const sel=document.getElementById('inp-matiere');
  const defaults=['Sciences','Anglais','Fran√ßais','Math√©matiques','Histoire-G√©o'];
  const customs=[...new Set((competences||[]).map(c=>c.matiere))].filter(m=>m&&!defaults.includes(m)).sort((a,b)=>a.localeCompare(b));
  sel.innerHTML=defaults.map(m=>`<option>${m}</option>`).join('')+(customs.length?`<option disabled>‚Äî Mes mati√®res ‚Äî</option>`:'')+customs.map(m=>`<option>${m}</option>`).join('')+`<option>Autre</option>`;
  document.getElementById('matiereCustomWrap').classList.add('hidden');
}
function onMatiereChange() {
  const isOther=document.getElementById('inp-matiere').value==='Autre';
  document.getElementById('matiereCustomWrap').classList.toggle('hidden',!isOther);
  if(!isOther) document.getElementById('inp-matiere-custom').value='';
}

// DELETE
async function deleteCompetence(compId) {
  if(!confirm("Supprimer cette comp√©tence et ses notes ?")) return;
  try {
    await db.from('notes').delete().eq('competence_id',compId).eq('user_id',currentUser.id);
    await db.from('competences').delete().eq('id',compId).eq('user_id',currentUser.id);
    competences=competences.filter(c=>c.id!==compId);
    Object.keys(notes).forEach(k=>{if(Number(k.split('_')[1])===compId) delete notes[k];});
    await quickRefresh();
    showToast("Comp√©tence supprim√©e ‚úì");
  } catch(e){showToast("Erreur suppression ‚ö†Ô∏è");}
}
async function deleteMatiere(matiere) {
  if(!confirm(`Supprimer la mati√®re "${matiere}" et tout son contenu ?`)) return;
  try {
    const ids=competences.filter(c=>c.matiere===matiere).map(c=>c.id);
    if(ids.length){
      await db.from('notes').delete().in('competence_id',ids).eq('user_id',currentUser.id);
      await db.from('competences').delete().in('id',ids).eq('user_id',currentUser.id);
    }
    competences=competences.filter(c=>c.matiere!==matiere);
    const s=new Set(ids); Object.keys(notes).forEach(k=>{if(s.has(Number(k.split('_')[1]))) delete notes[k];});
    await quickRefresh();
    showToast("Mati√®re supprim√©e ‚úì");
  } catch(e){showToast("Erreur suppression ‚ö†Ô∏è");}
}
async function deleteEleve(eleveId) {
  const e=eleves.find(x=>x.id===eleveId);
  if(!confirm(`Supprimer ${e?e.prenom+' '+e.nom:'cet √©l√®ve'} et toutes ses notes ?`)) return;
  try {
    await db.from('notes').delete().eq('eleve_id',eleveId).eq('user_id',currentUser.id);
    await db.from('eleves').delete().eq('id',eleveId).eq('user_id',currentUser.id);
    eleves=eleves.filter(x=>x.id!==eleveId);
    Object.keys(notes).forEach(k=>{if(Number(k.split('_')[0])===eleveId) delete notes[k];});
    await quickRefresh(); showScreen('accueil'); showToast("√âl√®ve supprim√© ‚úì");
  } catch(e){showToast("Erreur suppression ‚ö†Ô∏è");}
}

// TOAST
let toastTimer;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2800);}


// EDIT ELEVE
let editingEleveId = null;
let selectedEditGenre = 'M';

function openEditEleve(eleveId) {
  const e = eleves.find(x => x.id === eleveId);
  if (!e) return;
  editingEleveId = eleveId;
  document.getElementById('edit-prenom').value = e.prenom;
  document.getElementById('edit-nom').value = e.nom;
  document.getElementById('edit-niveau').value = e.niveau;
  selectEditGenre(e.sexe || '');
  openModal('modalEditEleve');
}

function selectEditGenre(val) {
  selectedEditGenre = val;
  document.getElementById('edit-genre-boy').className = 'genre-btn' + (val === 'M' ? ' selected-boy' : '');
  document.getElementById('edit-genre-girl').className = 'genre-btn' + (val === 'F' ? ' selected-girl' : '');
}

async function updateEleve() {
  if (!editingEleveId) return;
  const prenom = document.getElementById('edit-prenom').value.trim();
  const nom = document.getElementById('edit-nom').value.trim().toUpperCase();
  const niveau = document.getElementById('edit-niveau').value;
  const sexe = selectedEditGenre;
  if (!prenom || !nom) { showToast('Remplis pr√©nom et nom'); return; }
  try {
    const { error } = await db.from('eleves')
      .update({ prenom, nom, niveau, sexe })
      .eq('id', editingEleveId)
      .eq('user_id', currentUser.id);
    if (error) throw error;
    closeModal('modalEditEleve');
    await quickRefresh();
    showToast('√âl√®ve mis √† jour ‚úì');
  } catch(e) { showToast('Erreur lors de la modification ‚ö†Ô∏è'); console.error(e); }
}






// S√âLECTEUR DE P√âRIODES POUR NOUVELLE COMP√âTENCE
let compPeriodes = new Set(['P3']); // P3 s√©lectionn√©e par d√©faut

function initCompPeriodes() {
  compPeriodes = new Set(['P3']);
  ['P1','P2','P3','P4','P5'].forEach(p => {
    const btn = document.getElementById('comp-' + p.toLowerCase());
    if (btn) btn.className = 'genre-btn' + (p === 'P3' ? ' selected-unknown' : '');
  });
}

function toggleCompPeriode(p) {
  const btn = document.getElementById('comp-' + p.toLowerCase());
  if (compPeriodes.has(p)) {
    if (compPeriodes.size === 1) { showToast('S√©lectionne au moins une p√©riode'); return; }
    compPeriodes.delete(p);
    btn.className = 'genre-btn';
  } else {
    compPeriodes.add(p);
    btn.className = 'genre-btn selected-unknown';
  }
}

// ============================================================
// ONGLET √âDITER dans la grille
// ============================================================
let editGrilleOpen = false;

function openEditGrille(el) {
  editGrilleOpen = !editGrilleOpen;
  const panel = document.getElementById('editGrillePanel');
  const chip = document.getElementById('chip-edit-grille');
  if (editGrilleOpen) {
    panel.style.display = 'block';
    chip.classList.add('active');
    renderEditGrille();
  } else {
    panel.style.display = 'none';
    chip.classList.remove('active');
  }
}

function renderEditGrille() {
  const filtered = activePeriodeFilter === 'all'
    ? competences
    : competences.filter(c => c.periode === activePeriodeFilter);

  const matieres = [...new Set(filtered.map(c => c.matiere))];
  const allMatieres = [...new Set(competences.map(c => c.matiere))];

  if (!allMatieres.length) {
    document.getElementById('editGrilleContent').innerHTML =
      '<p style="color:var(--muted);font-size:0.82rem;text-align:center;padding:16px 0">Aucune mati√®re ‚Äî ajoutez-en une via le menu Ôºã</p>';
    return;
  }

  let html = '';
  allMatieres.forEach(m => {
    const safeM = m.replace(/'/g, "\'");
    const comps = competences.filter(c => c.matiere === m && c.nom !== '(mati√®re)');
    html += `<div style="margin-bottom:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--surface2);border-radius:10px;margin-bottom:6px;border:1.5px solid var(--border)">
        <span style="font-size:0.78rem;font-weight:800">${m}</span>
        <button onclick="deleteMatiere('${safeM}')" class="icon-btn danger" style="width:26px;height:26px;font-size:0.7rem">üóëÔ∏è</button>
      </div>`;
    if (comps.length === 0) {
      html += `<p style="font-size:0.72rem;color:var(--muted);padding:4px 10px">Aucune comp√©tence</p>`;
    }
    comps.forEach(c => {
      html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-bottom:1px solid var(--border)">
        <div style="font-size:0.78rem;flex:1;padding-right:8px">
          <span style="font-weight:600">${c.nom}</span>
          <span style="font-size:0.62rem;color:var(--muted);margin-left:6px;background:var(--bg);padding:1px 6px;border-radius:4px">${c.periode}</span>
          ${c.date_eval ? `<span style="font-size:0.6rem;color:var(--muted)"> ¬∑ ${c.date_eval}</span>` : ''}
        </div>
        <button onclick="deleteCompetence(${c.id})" class="icon-btn danger" style="width:26px;height:26px;font-size:0.7rem">üóëÔ∏è</button>
      </div>`;
    });
    html += '</div>';
  });

  document.getElementById('editGrilleContent').innerHTML = html;
}

// DUPLIQUER MATI√àRE
let dupPeriodes = new Set(['P1','P2','P3','P4','P5']);

function openDupMatiere() {
  const sel = document.getElementById('dup-matiere');
  const defaults = ['Sciences','Anglais','Fran√ßais','Math√©matiques','Histoire-G√©o'];
  const customs = [...new Set((competences||[]).map(c=>c.matiere))].filter(m=>m&&!defaults.includes(m)).sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = defaults.map(m=>`<option>${m}</option>`).join('') +
    (customs.length ? `<option disabled>‚Äî Mes mati√®res ‚Äî</option>` : '') +
    customs.map(m=>`<option>${m}</option>`).join('') +
    `<option>Autre</option>`;
  document.getElementById('dupMatiereCustomWrap').classList.add('hidden');
  document.getElementById('dup-comp').value = '';
  // Reset p√©riodes ‚Äî tout s√©lectionn√©
  dupPeriodes = new Set(['P1','P2','P3','P4','P5']);
  ['P1','P2','P3','P4','P5'].forEach(p => {
    const btn = document.getElementById('dup-'+p.toLowerCase());
    if(btn) btn.className = 'genre-btn selected-unknown';
  });
}

function onDupMatiereChange() {
  const isOther = document.getElementById('dup-matiere').value === 'Autre';
  document.getElementById('dupMatiereCustomWrap').classList.toggle('hidden', !isOther);
  if(!isOther) document.getElementById('dup-matiere-custom').value = '';
}

function toggleDupPeriode(p) {
  const btn = document.getElementById('dup-'+p.toLowerCase());
  if(dupPeriodes.has(p)) {
    dupPeriodes.delete(p);
    btn.className = 'genre-btn';
  } else {
    dupPeriodes.add(p);
    btn.className = 'genre-btn selected-unknown';
  }
}

async function dupMatiere() {
  let matiere = document.getElementById('dup-matiere').value;
  const custom = (document.getElementById('dup-matiere-custom')?.value||'').trim();
  if(matiere === 'Autre') {
    if(!custom) { showToast('Saisis le nom de la mati√®re'); return; }
    matiere = custom;
  }
  if(dupPeriodes.size === 0) { showToast('S√©lectionne au moins une p√©riode'); return; }

  // Trouver les p√©riodes o√π cette mati√®re n'existe pas encore (m√™me vide)
  const existantes = new Set(competences.filter(c=>c.matiere===matiere).map(c=>c.periode));
  const aCreer = [...dupPeriodes].filter(p=>!existantes.has(p));

  if(aCreer.length === 0) {
    showToast('Cette mati√®re existe d√©j√† dans toutes les p√©riodes s√©lectionn√©es');
    return;
  }

  const nomComp = (document.getElementById('dup-comp')?.value || '').trim();

  try {
    let rows;
    if (nomComp) {
      // Avec comp√©tence : √©viter les doublons comp+mati√®re+p√©riode
      const existComp = new Set(
        competences.filter(c=>c.matiere===matiere && c.nom===nomComp).map(c=>c.periode)
      );
      const aCreerComp = aCreer.filter(p=>!existComp.has(p));
      if (aCreerComp.length === 0) {
        showToast('Cette comp√©tence existe d√©j√† dans toutes les p√©riodes s√©lectionn√©es');
        return;
      }
      rows = aCreerComp.map(p => ({ matiere, nom: nomComp, periode: p, date_eval: null, user_id: currentUser.id }));
    } else {
      // Sans comp√©tence : cr√©er une entr√©e placeholder "(mati√®re)" uniquement
      // si la mati√®re n'a aucune comp√©tence dans cette p√©riode
      const existMat = new Set(competences.filter(c=>c.matiere===matiere).map(c=>c.periode));
      const aCreerMat = aCreer.filter(p=>!existMat.has(p));
      if (aCreerMat.length === 0) {
        showToast('Cette mati√®re existe d√©j√† dans toutes les p√©riodes s√©lectionn√©es');
        return;
      }
      rows = aCreerMat.map(p => ({ matiere, nom: '(mati√®re)', periode: p, date_eval: null, user_id: currentUser.id }));
    }

    const { error } = await db.from('competences').insert(rows);
    if(error) throw error;
    closeModal('modalMatiere');
    document.getElementById('dup-comp').value = '';
    await quickRefresh();
    refreshMatiereSelect();
    const msg = nomComp ? `"${nomComp}" ajout√©e sur ${aCreer.join(', ')} ‚úì` : `"${matiere}" dupliqu√©e sur ${aCreer.join(', ')} ‚úì`;
    showToast(msg);
  } catch(e) { showToast("Erreur lors de la duplication ‚ö†Ô∏è"); console.error(e); }
}

init();
</script>
</body>
</html>
